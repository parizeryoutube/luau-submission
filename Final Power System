
--[[
	ðŸ”¥ Power System Rewrite (LocalScript) ðŸ”¥
	Author: parizeryoutube
	Purpose: Final version with full VFX, safe RemoteEvent usage, and camera effects.
--]]

--// SERVICES
local Players = game:GetService("Players")
local ContextActionService = game:GetService("ContextActionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")

--// VARIABLES
local player = Players.LocalPlayer
local character, humanoid, root, camera

-- Cooldown config
local cooldowns = { Dash = 2, Shield = 6 }
local lastUsed = { Dash = 0, Shield = 0 }

-- Fireball charge tracking
local charging = false
local chargeStartTime = 0

-- RemoteEvent for damage application on server
local fireballEvent = ReplicatedStorage:WaitForChild("RequestFireballHit")

-- GUI setup for shield cooldown bar
local shieldGui = Instance.new("ScreenGui")
shieldGui.Name = "ShieldGui"
shieldGui.Parent = player:WaitForChild("PlayerGui")

local shieldBar = Instance.new("Frame")
shieldBar.Size = UDim2.new(0, 200, 0, 20)
shieldBar.Position = UDim2.new(0.5, -100, 0.92, 0)
shieldBar.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
shieldBar.BorderSizePixel = 0
shieldBar.AnchorPoint = Vector2.new(0.5, 0)
shieldBar.Visible = false
shieldBar.Parent = shieldGui

local shieldFill = Instance.new("Frame")
shieldFill.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
shieldFill.BorderSizePixel = 0
shieldFill.Size = UDim2.new(1, 0, 1, 0)
shieldFill.Parent = shieldBar

-- Utility: cooldown check
local function isOnCooldown(action)
	return tick() - lastUsed[action] < cooldowns[action]
end

-- Utility: play sound with cleanup
local function createSound(id, parent, volume)
	local sfx = Instance.new("Sound")
	sfx.SoundId = "rbxassetid://" .. id
	sfx.Volume = volume or 1
	sfx.Parent = parent
	sfx:Play()
	Debris:AddItem(sfx, 3)
	return sfx
end

-- Ability: Dash forward with blur, trail, and sound
local function dash()
	if isOnCooldown("Dash") or not root then return end
	lastUsed.Dash = tick()

	-- Launch forward
	root.AssemblyLinearVelocity = root.CFrame.LookVector * 100

	-- Add motion blur effect
	local blur = Instance.new("BlurEffect")
	blur.Size = 20
	blur.Parent = Lighting
	Debris:AddItem(blur, 0.25)

	-- Add trail for motion
	local trail = Instance.new("Trail")
	trail.Attachment0 = Instance.new("Attachment", root)
	trail.Attachment1 = Instance.new("Attachment", root)
	trail.Lifetime = 0.2
	trail.Color = ColorSequence.new(Color3.new(1, 1, 1))
	trail.Transparency = NumberSequence.new(0.2)
	trail.Parent = root
	Debris:AddItem(trail, 0.3)

	createSound(12221967, root, 2)
end

-- Ability: Activate shield, show GUI, and tag for immunity
local function activateShield()
	if isOnCooldown("Shield") or not root then return end
	lastUsed.Shield = tick()

	shieldBar.Visible = true
	shieldFill.Size = UDim2.new(1, 0, 1, 0)

	local shield = Instance.new("Part")
	shield.Shape = Enum.PartType.Ball
	shield.Size = Vector3.new(8,8,8)
	shield.CanCollide = false
	shield.Anchored = false
	shield.Material = Enum.Material.ForceField
	shield.Color = Color3.fromRGB(0, 170, 255)
	shield.CFrame = root.CFrame
	shield.Parent = workspace

	local weld = Instance.new("WeldConstraint")
	weld.Part0 = root
	weld.Part1 = shield
	weld.Parent = shield

	local tag = Instance.new("BoolValue")
	tag.Name = "Shielded"
	tag.Parent = character
	Debris:AddItem(tag, 3)
	Debris:AddItem(shield, 3)

	TweenService:Create(shieldFill, TweenInfo.new(cooldowns.Shield), { Size = UDim2.new(0, 0, 1, 0) }):Play()

	task.delay(cooldowns.Shield, function()
		shieldBar.Visible = false
	end)
end

-- Ability: Launch a fireball with velocity and FX
local function fireFireball(chargeTime)
	if not root then return end

	local fireball = Instance.new("Part")
	fireball.Shape = Enum.PartType.Ball
	fireball.Size = Vector3.new(2,2,2)
	fireball.Material = Enum.Material.Neon
	fireball.BrickColor = BrickColor.new("Bright orange")
	fireball.CFrame = root.CFrame + root.CFrame.LookVector * 3
	fireball.CanCollide = false
	fireball.Anchored = false
	fireball.Name = "Fireball"
	fireball.Parent = workspace

	-- Light effect
	local light = Instance.new("PointLight")
	light.Color = Color3.new(1, 0.5, 0)
	light.Brightness = 2
	light.Range = 10
	light.Parent = fireball

	-- Speed scales with charge time
	local speed = 100 + (300 - 100) * math.clamp((chargeTime - 0.2) / (3 - 0.2), 0, 1)
	fireball.AssemblyLinearVelocity = root.CFrame.LookVector * speed

	-- Trail visuals
	local trail = Instance.new("Trail")
	trail.Attachment0 = Instance.new("Attachment", fireball)
	trail.Attachment1 = Instance.new("Attachment", fireball)
	trail.Lifetime = 0.3
	trail.Color = ColorSequence.new(Color3.fromRGB(255, 100, 0))
	trail.Transparency = NumberSequence.new(0.1)
	trail.Parent = fireball

	-- Launch burst FX
	local emitter = Instance.new("ParticleEmitter")
	emitter.Texture = "rbxassetid://243660364"
	emitter.Rate = 50
	emitter.Lifetime = NumberRange.new(0.2)
	emitter.Speed = NumberRange.new(1,3)
	emitter.Size = NumberSequence.new(0.5)
	emitter.Parent = fireball
	Debris:AddItem(emitter, 1)

	-- Server-side damage trigger
	local touched = false
	fireball.Touched:Connect(function(hit)
		if touched or hit:IsDescendantOf(character) then return end
		touched = true

		-- Request damage via RemoteEvent
		fireballEvent:FireServer(hit)

		-- Visual explosion
		local explosion = Instance.new("Explosion")
		explosion.Position = fireball.Position
		explosion.BlastPressure = 0
		explosion.BlastRadius = 6
		explosion.Parent = workspace

		createSound(138186576, fireball, 2)
		fireball:Destroy()

		-- Camera shake
		local start = tick()
		RunService:BindToRenderStep("Shake", Enum.RenderPriority.Camera.Value + 1, function()
			if tick() - start > 0.25 then
				RunService:UnbindFromRenderStep("Shake")
				return
			end
			camera.CFrame *= CFrame.new(math.random(-1,1)/20, math.random(-1,1)/20, 0)
		end)
	end)

	Debris:AddItem(fireball, 5)
end

-- Bind key inputs to functions
ContextActionService:BindAction("Dash", function(_, state)
	if state == Enum.UserInputState.Begin then dash() end
end, false, Enum.KeyCode.Q)

ContextActionService:BindAction("Shield", function(_, state)
	if state == Enum.UserInputState.Begin then activateShield() end
end, false, Enum.KeyCode.R)

ContextActionService:BindAction("Charge", function(_, state)
	if state == Enum.UserInputState.Begin then
		charging = true
		chargeStartTime = tick()
	elseif state == Enum.UserInputState.End and charging then
		charging = false
		local chargeTime = tick() - chargeStartTime
		if chargeTime >= 0.2 then
			fireFireball(chargeTime)
		end
	end
end, false, Enum.KeyCode.E)

-- Initialize character refs
local function setupCharacter()
	character = player.Character or player.CharacterAdded:Wait()
	humanoid = character:WaitForChild("Humanoid")
	root = character:WaitForChild("HumanoidRootPart")
	camera = workspace.CurrentCamera
end

-- Setup on respawn
player.CharacterAdded:Connect(setupCharacter)
setupCharacter()

print("âœ… Power System Loaded")
